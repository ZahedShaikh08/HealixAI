<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HealixAI | Intelligent Diagnosis System</title>

    <link rel="icon" type="image/jpeg" sizes="32x32" href="{{ url_for('static', filename='img/Healix-ai_circle.png') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <nav class="floating-nav" role="navigation">
        <a href="/" class="logo">
            <img src="{{ url_for('static', filename='img/Healix-ai.jpeg') }}"
                style="width: 35px; height: 35px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2);">
            HealixAI
        </a>

        <div class="d-none d-md-flex gap-4">
            <a href="/" class="text-highlight">Diagnosis</a>
            <a href="/technology" class="text-highlight">Technology</a>
            <a href="/symptoms" class="text-highlight">Symptoms</a>
        </div>

        <button class="btn border-0 text-white d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
            <i class="fa-solid fa-bars fs-4"></i>
        </button>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu"
        style="background: var(--bg-deep); border-left: 1px solid rgba(94, 234, 212, 0.2);">
        <div class="offcanvas-header">
            <h5 class="text-highlight fw-bold">Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column gap-4 p-4">
            <a href="/" class="fs-4 text-white"><i class="fa-solid fa-stethoscope me-3 text-primary"></i>Diagnosis</a>
            <a href="/technology" class="fs-4 text-white"><i class="fa-solid fa-microchip me-3 text-secondary"></i>Technology</a>
            <a href="/symptoms" class="fs-4 text-white"><i class="fa-solid fa-list-ul me-3 text-warning"></i>Symptoms</a>
        </div>
    </div>

    <header class="hero container">
        <div class="reveal">
            <div class="badge-inline">
                <small class="text-highlight fw-bold">✨ AI-Assisted Healthcare Assessment v2.0</small>
            </div>
            <h1 class="display-3 fw-bold mb-4">
                Intelligent Diagnosis.<br />
                <span class="text-highlight">Human Care.</span>
            </h1>
            <p class="lead text-white-soft mx-auto" style="max-width:600px;">
                <span id="hero-typing" class="typing-cursor text-white-soft"></span>
            </p>
            <div class="mt-5 d-flex justify-content-center gap-3">
                <a href="#diagnosis" class="btn-modern btn-primary-glow" aria-label="Start checkup">
                    Start Checkup <i class="fa-solid fa-arrow-down"></i>
                </a>
            </div>
        </div>
    </header>

    <section id="diagnosis" class="section-padding">
        <div class="container diagnosis-container">

            {% if message %}
            <div class="alert alert-danger glass-panel border-0 text-white mb-4 d-flex align-items-start gap-3" role="alert">
                <i class="fa-solid fa-triangle-exclamation text-danger mt-1"></i>
                <div class="w-100"> {{ message|safe }} </div>
            </div>
            {% endif %}

            <div class="glass-panel p-4 p-md-5 reveal" aria-live="polite">

                {% if predicted_disease %}
                <div class="fade-in-down mb-4 mx-auto" style="max-width: 500px;">
                    <div class="glass-panel p-3 border-0 d-flex align-items-center gap-3 shadow-sm" style="background: rgba(94, 234, 212, 0.1);">
                        <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="background-color: #0d9488; width: 40px; height: 40px;">
                            <i class="fa-solid fa-brain text-white"></i>
                        </div>
                        <div class="text-start flex-grow-1">
                            <h6 class="text-highlight mb-0 small fw-bold">Have questions about {{ predicted_disease }}?</h6>
                            <p class="text-white-soft small mb-0" style="font-size: 0.85rem;">Switch to <strong>AI Assistant</strong> below to ask for advice.</p>
                        </div>
                        <button type="button" class="btn-close btn-close-white small" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
                {% endif %}

                <div class="text-center">
                    <div class="mode-switch" role="tablist" aria-label="Mode switch">
                        <button type="button" class="mode-btn active" id="btn-diagnosis" aria-controls="view-diagnosis" onclick="toggleMode('diagnosis')" role="tab" aria-selected="true">
                            <i class="fa-solid fa-stethoscope me-2"></i>Diagnosis
                        </button>
                        <button type="button" class="mode-btn" id="btn-chat" aria-controls="view-chat" onclick="toggleMode('chat')" role="tab" aria-selected="false">
                            <i class="fa-solid fa-comments me-2"></i>AI Assistant
                        </button>
                    </div>
                </div>

                <div id="view-diagnosis">
                    <form action="/predict" method="post" class="mt-4" id="prediction-form" novalidate>
                        {% if csrf_token %}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        {% endif %}

                        <div class="mb-4 position-relative">
                            <label for="symptoms" class="form-label text-black-strong small text-uppercase fw-bold mb-2">Describe Symptoms</label>

                            <div class="input-group input position-relative">
                                <input type="text" id="symptoms" name="symptoms" class="modern-input rounded-4" placeholder="e.g. severe headache, nausea, stiff neck..." required aria-required="true" autocomplete="off" />
                                <button type="button" id="startSpeechRecognition" class="btn mic-btn position-absolute end-0 top-50 translate-middle-y me-3" style="z-index:5;" aria-label="Start voice input">
                                    <i class="fa-solid fa-microphone"></i>
                                </button>
                            </div>

                            <div id="suggestions-container" class="suggestions position-absolute w-100 rounded mt-1 p-2 shadow-lg" style="display:none; z-index:10;" aria-hidden="true"></div>
                            <div id="transcription" class="form-text text-highlight mt-2" aria-live="polite"></div>
                        </div>

                        <button type="submit" class="btn-modern btn-primary-glow w-100 justify-content-center" id="predictBtn" aria-live="polite">
                            <span id="btnText">Run Analysis</span>
                            <div id="btnSpinner" class="ai-loader ms-2 d-none" role="status" aria-hidden="true"></div>
                        </button>
                    </form>
                </div>

                <div id="view-chat" style="display: none;">
                    <div class="chat-box mb-3" id="chatHistory" aria-live="polite" aria-label="Chat history">
                        <div class="message msg-ai" role="article">
                            <strong>Healix AI:</strong> Hello! I am your virtual health assistant. Describe your symptoms or ask me about a condition.
                        </div>
                    </div>

                    <div class="chat-input-wrapper" role="group" aria-label="Chat input">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your health question..." aria-label="Chat input" />
                        <button id="sendChatBtn" class="chat-send-btn" aria-label="Send chat message">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </section>

    {% if predicted_disease %}
    <section id="results" class="section-padding pt-0">
        <div class="container">
            <div class="text-center mb-5 reveal">
                <h2 class="display-5 fw-bold">Analysis Complete</h2>
                <p class="text-white-soft">Here is the AI-generated medical report based on your inputs.</p>
            </div>

            <div class="bento-grid">
                <div class="glass-panel bento-card reveal" style="grid-column: span 2; background: linear-gradient(145deg, rgba(94, 234, 212, 0.05), transparent);">
                    <div class="bento-title"><i class="fa-solid fa-triangle-exclamation text-warning"></i> Primary Diagnosis</div>
                    <h3 class="disease-highlight mb-3">{{ predicted_disease }}</h3>
                    <p class="text-white-soft">{{ dis_des }}
                        Confidence Level: <strong>{{ confidence }}%</strong>
                    </p>
                </div>

                <div class="glass-panel bento-card reveal">
                    <div class="bento-title"><i class="fa-solid fa-pills" style="color: var(--primary)"></i> Medications</div>
                    <ul class="custom-list list-unstyled">
                        {% for med in medications %}
                        <li>{{ med }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="glass-panel bento-card reveal">
                    <div class="bento-title"><i class="fa-solid fa-shield-virus" style="color: var(--secondary)"></i> Precautions</div>
                    <ul class="custom-list list-unstyled">
                        {% for item in my_precautions %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="glass-panel bento-card reveal">
                    <div class="bento-title"><i class="fa-solid fa-apple-whole text-danger"></i> Recommended Diet</div>
                    <ul class="custom-list list-unstyled">
                        {% for d in my_diet %}
                        <li>{{ d }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="glass-panel bento-card reveal">
                    <div class="bento-title"><i class="fa-solid fa-person-running text-warning"></i> Suggested Workout</div>
                    <ul class="custom-list list-unstyled">
                        {% for w in workout_list %}
                        <li>{{ w }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="glass-panel bento-card reveal">
                    <h6 class="text-highlight mb-2">How the assessment was made</h6>
                    <ul class="custom-list list-unstyled">
                        {% for item in explanation %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="glass-panel bento-card reveal" style="grid-column: span 2; background: linear-gradient(145deg, rgba(94, 234, 212, 0.05), transparent);">
                    <div class="bento-title"><i class="fa-solid fa-location-dot text-danger"></i> Next Steps</div>
                    <p class="small text-white-soft mb-3">Find a specialist for {{ predicted_disease }} near you.</p>
                    
                    <a href="https://www.google.com/maps/search/{{ predicted_disease }}+doctor+near+me" target="_blank"
                        class="btn-modern w-100 justify-content-center" style="background: rgba(255,255,255,0.1);">
                        Open Maps
                        <i class="fa-solid fa-external-link-alt ms-2"></i>
                    </a>
                </div>

                <div class="glass-panel bento-card reveal" style="grid-column: 1 / -1; background: linear-gradient(145deg, rgba(94, 234, 212, 0.05), transparent);">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fa-solid fa-circle-exclamation text-warning"></i>
                        <h6 class="mb-0 text-highlight">Medical Disclaimer</h6>
                    </div>
                    <p class="text-white-soft small mb-0">
                        This AI-generated result is for informational purposes only and does not
                        constitute medical advice, diagnosis, or treatment. Always consult a
                        qualified healthcare professional for an accurate diagnosis and
                        appropriate medical care.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
        <div id="resultToast" class="glass-panel p-3 text-white d-flex align-items-center gap-3" role="alert" aria-live="assertive" aria-atomic="true">
            <i class="fa-solid fa-check-circle text-success fs-4"></i>
            <div>
                <strong>Diagnosis Ready</strong><br />
                <small class="text-white-soft">Scroll down to view report.</small>
            </div>
            <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}

    <footer class="container text-center py-5 border-top border-secondary border-opacity-10 mt-5">
        <p class="text-white-soft small">
            © 2025 HealixAI. <span class="text-warning">Disclaimer: AI predictions are for informational purposes only. Consult a doctor.</span>
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        const symptomInput = document.getElementById('symptoms');
        const suggestionsBox = document.getElementById('suggestions-container');
        const speechBtn = document.getElementById('startSpeechRecognition');
        const transcriptionDiv = document.getElementById('transcription');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendChatBtn');
        const chatHistory = document.getElementById('chatHistory');
        const predictionForm = document.getElementById('prediction-form');

        // --- 2. VIEW TOGGLING (Diagnosis vs Chat) ---
        function toggleMode(mode) {
            const diagView = document.getElementById('view-diagnosis');
            const chatView = document.getElementById('view-chat');
            const btnDiag = document.getElementById('btn-diagnosis');
            const btnChat = document.getElementById('btn-chat');

            if (mode === 'chat') {
                diagView.style.display = 'none';
                chatView.style.display = 'block';
                chatView.classList.add('reveal', 'active');

                btnDiag.classList.remove('active');
                btnDiag.setAttribute('aria-selected', 'false');
                btnChat.classList.add('active');
                btnChat.setAttribute('aria-selected', 'true');

                if (chatInput) chatInput.focus();
            } else {
                chatView.style.display = 'none';
                diagView.style.display = 'block';

                btnChat.classList.remove('active');
                btnChat.setAttribute('aria-selected', 'false');
                btnDiag.classList.add('active');
                btnDiag.setAttribute('aria-selected', 'true');
            }
        }

        // --- 3. SCROLL REVEAL ANIMATION ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('active');
            });
        }, {
            threshold: 0.1
        });

        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        // --- 4. SPEECH RECOGNITION ---
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        if (speechBtn) {
            speechBtn.addEventListener('click', () => {
                if (!window.SpeechRecognition) {
                    alert("Your browser doesn't support the Web Speech API. Try Chrome or Edge.");
                    return;
                }

                const recognition = new window.SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                // UI feedback
                speechBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-primary"></i>';
                transcriptionDiv.textContent = 'Listening...';

                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    if (symptomInput) symptomInput.value = result;
                    transcriptionDiv.textContent = "Heard: " + result;
                    speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';

                    // Trigger suggestion logic manually after voice input
                    symptomInput.dispatchEvent(new Event('input'));
                };

                recognition.onerror = (e) => {
                    console.error('Speech error', e);
                    transcriptionDiv.textContent = 'Voice input failed. Please try typing.';
                    speechBtn.innerHTML = '<i class="fa-solid fa-microphone-slash text-danger"></i>';
                    setTimeout(() => {
                        speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    }, 1500);
                };

                recognition.onend = () => {
                    if (speechBtn.innerHTML.includes('spinner')) {
                        speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    }
                };

                try {
                    recognition.start();
                } catch (err) {
                    console.warn('Recognition start error', err);
                    transcriptionDiv.textContent = 'Voice input unavailable.';
                    speechBtn.innerHTML = '<i class="fa-solid fa-microphone-slash text-danger"></i>';
                    setTimeout(() => {
                        speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    }, 1200);
                }
            });
        }

        // --- 5. SMART SUGGESTIONS ---
        if (suggestionsBox) {
            suggestionsBox.style.backgroundColor = 'rgba(20, 20, 20, 0.95)';
            suggestionsBox.style.backdropFilter = 'blur(10px)';
            suggestionsBox.style.border = '1px solid rgba(94, 234, 212, 0.2)';
        }

        if (symptomInput && suggestionsBox) {
            symptomInput.addEventListener('input', async function() {
                const query = this.value;
                if (query.length < 2) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                try {
                    const response = await fetch(`/api/suggest?q=${encodeURIComponent(query)}`);
                    const symptoms = await response.json();

                    if (symptoms.length > 0) {
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'block';

                        symptoms.forEach(sym => {
                            const readable = sym.replace(/_/g, ' ');
                            const capitalized = readable.charAt(0).toUpperCase() + readable.slice(1);

                            const div = document.createElement('div');
                            div.className = 'p-2 text-white-soft small border-bottom border-secondary border-opacity-10 suggestion-item';
                            div.style.cursor = 'pointer';
                            div.innerHTML = `<i class="fa-solid fa-plus text-primary me-2"></i>${capitalized}`;

                            div.onclick = () => {
                                const currentVal = symptomInput.value;
                                const lastComma = currentVal.lastIndexOf(',');
                                let newVal;
                                if (lastComma !== -1) {
                                    newVal = currentVal.substring(0, lastComma + 1).trim() + ' ' + sym;
                                } else {
                                    newVal = sym;
                                }
                                symptomInput.value = newVal + ', ';
                                suggestionsBox.style.display = 'none';
                                symptomInput.focus();
                            };
                            suggestionsBox.appendChild(div);
                        });
                    } else {
                        suggestionsBox.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Suggestion error:", e);
                }
            });

            // Hide suggestions on click outside
            document.addEventListener('click', (e) => {
                if (e.target !== symptomInput && e.target !== suggestionsBox) {
                    suggestionsBox.style.display = 'none';
                }
            });
        }

        // --- 6. FORM SUBMISSION UI ---
        if (predictionForm) {
            predictionForm.addEventListener('submit', () => {
                const btn = document.getElementById('predictBtn');
                const spinner = document.getElementById('btnSpinner');
                const text = document.getElementById('btnText');

                if (btn) btn.disabled = true;
                if (text) text.textContent = 'Processing...';
                if (spinner) spinner.classList.remove('d-none');
                
                // ✅ FIX 2: Hide suggestions box on form submit (Enter key or Button Click)
                if (suggestionsBox) suggestionsBox.style.display = 'none';
            });
        }

        // --- 7. CHAT LOGIC ---
        async function sendMessage() {
            const txt = chatInput.value.trim();
            if (!txt) return;

            // Disable the button so user can't click again
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.style.opacity = "0.5"; // Optional: makes it look disabled
                sendBtn.style.cursor = "not-allowed";
            }

            // 1. Show User Message
            appendMessage('user', txt);
            chatInput.value = '';

            // 2. Show "Thinking..." text
            const loaderId = "loader-" + Date.now();
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'message msg-ai';
            loaderDiv.id = loaderId;
            loaderDiv.innerHTML = `<strong>Healix AI:</strong> <div class="ai-content">Thinking...</div>`;

            chatHistory.appendChild(loaderDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                // 3. Send to Backend
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: txt
                    })
                });

                const data = await res.json();

                // 4. Remove the "Thinking..." message
                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();

                // 5. Show Real Response or Error
                if (!res.ok || data.error) {
                    const errorMsg = data.error || 'AI service unavailable.';
                    appendMessage('ai', `⚠️ Error: ${errorMsg}`);
                } else {
                    appendMessage('ai', data.response);
                }

            } catch (err) {
                console.error('Chat error:', err);
                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();
                appendMessage('ai', '❌ Network error. Please check your internet or server console.');
            } finally {
                // Re-enable the button when done (Success or Error)
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = "1";
                    sendBtn.style.cursor = "pointer";
                }
                // Optional: Put focus back on input so user can type next question immediately
                if (chatInput) chatInput.focus();
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'msg-user' : 'msg-ai'}`;

            if (role === 'ai') {
                div.innerHTML = `<div class="ai-content"></div>`;
                chatHistory.appendChild(div);

                // Render Markdown safely
                const contentDiv = div.querySelector('.ai-content');
                if (typeof marked !== 'undefined') {
                    contentDiv.innerHTML = marked.parse(text);
                } else {
                    contentDiv.textContent = text;
                }
            } else {
                div.textContent = text;
                chatHistory.appendChild(div);
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
            chatInput && chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // --- 8. TYPEWRITER EFFECT ---
        document.addEventListener("DOMContentLoaded", () => {
            const text = "AI-assisted symptom assessment in seconds.";
            const el = document.getElementById("hero-typing");

            if (!el) return;
            el.textContent = "";
            let index = 0;
            const speed = 50;

            function typeWriter() {
                if (index < text.length) {
                    el.textContent += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, speed);
                }
            }
            typeWriter();
        });

        // --- 9. TOAST TRIGGER ---
        {% if predicted_disease %}
        window.addEventListener('load', () => {
            const toastEl = document.getElementById('resultToast');
            if (toastEl && bootstrap && bootstrap.Toast) new bootstrap.Toast(toastEl).show();
            const res = document.getElementById('results');
            if (res) res.scrollIntoView({
                behavior: 'smooth'
            });
        });
        {% endif %}
    </script>
</body>

</html>